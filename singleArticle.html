<!DOCTYPE html>
<html style="height:100%">
<head>
	<link rel="stylesheet" href="dist/CSS/bootstrap.css">
	<script src="dist/JS/jquery.min.js"></script>
	<script src="dist/JS/bootstrap.min.js"></script>
	<script src="dist/JS/jquery.idledetection.js"></script>
	<script src="dist/JS/myFunc.js"></script>
	<script language="javascript" src="dist/JS/artDialog.js"></script>
	<script src='http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.5/jquery-ui.min.js'></script>
	<link rel="stylesheet" href="dist/CSS/default.css"/>

    <link rel="stylesheet" href="dist/CSS/myFont.css">
	<style>
		.modal .modal-dialog{
			margin: 29vh auto;
		}
		.modal .modal-body{
			padding: 10vw;
		}
		.modal .modal-body p{
			font-size: 5vw;
			text-align: center;
		}
		.modal .modal-footer{
			display: flex;
			justify-content: space-evenly;
			padding: 20px;
		}
		.modal .modal-footer button{
			padding: 15px 80px;
			font-size: 35px;
		}
		.cart-badge{
			position: absolute;
		    width: 40px;
		    height: 40px;
		    border-radius: 50%;
		    background: white;
		    color: red;
		    font-size: 30px;
		    line-height: 45px;
		    font-weight: 700;
		    top: 20px;
		    right: 50px;
			-webkit-box-shadow: -2px 2px 4px 4px rgba(0,0,0,0.73);
			-moz-box-shadow: -2px 2px 4px 4px rgba(0,0,0,0.73);
			box-shadow: -2px 2px 4px 4px rgba(0,0,0,0.73);
			z-index: 10;
		}
		#snackbar {
			visibility: hidden; /* Hidden by default. Visible on click */
			min-width: 250px; /* Set a default minimum width */
			margin-left: -125px; /* Divide value of min-width by 2 */
			background-color: #333; /* Black background color */
			color: #fff; /* White text color */
			text-align: center; /* Centered text */
			border-radius: 15px; /* Rounded borders */
			padding: 30px 50px; /* Padding */
			position: fixed; /* Sit on top of the screen */
			z-index: 1; /* Add a z-index if needed */
			left: 42%; /* Center the snackbar */
			bottom: 300px; /* 30px from the bottom */
			font-size: 40px;
		}
		#snackbar.show {
			visibility: visible; /* Show the snackbar */
			/* Add animation: Take 0.5 seconds to fade in and out the snackbar.
			However, delay the fade out process for 2.5 seconds */
			-webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
			animation: fadein 0.5s, fadeout 0.5s 2.5s;
		}
		/* Animations to fade the snackbar in and out */
		@-webkit-keyframes fadein {
			from {bottom: 0; opacity: 0;}
			to {bottom: 300px; opacity: 1;}
		}

		@keyframes fadein {
			from {bottom: 0; opacity: 0;}
			to {bottom: 300px; opacity: 1;}
		}

		@-webkit-keyframes fadeout {
			from {bottom: 300px; opacity: 1;}
			to {bottom: 0; opacity: 0;}
		}

		@keyframes fadeout {
			from {bottom: 300px; opacity: 1;}
			to {bottom: 0; opacity: 0;}
		}
	</style>
<meta charset="UTF-8">
<title></title>
</head>
<body style="margin:0;padding:0;height:100%">
	<div id="towwpTitle" style="font-family:MyNewFont;font-size:9vw;padding-top:3%;text-align:center">Customize</div>

	<div style="width:70%;margin:0% auto 3% auto;font-size:2.3vw;text-align:center">
		Choose Any Toppings / Sugar & Ice Level
	</div>

	<div id="div1" style="width:80%;height:20%;margin:0 auto;box-shadow:5px 5px 8px #888888">
		<div style="height:100%">
			<div style="height:100%;width:50%;float:left">
				<div id="img" >
				</div >
			</div >
			<div style="height:100%;float:right;width:50%">
				<div id="desc" style="height:33%;font-size:3.5vw;text-align:center;"></div>
				<div style="width:55%;background:url(src/img/decorator2.png);background-size:100% 100%;background-repeat:no-repeat;height:7%;margin:-2% auto 3% auto"></div>
				<div id="note1" style="height:20%;width:90%;margin-top:5%;font-size:2.3vw;text-align:center"></div>
				<div id="note2" style="height:15%;margin-top:5%;font-size:3vw;text-align:center;color:red">
				</div>
			</div>
		</div>
	</div>

	<div id="div2" style="width:80%;height:40%;margin:3% auto 0 auto;overflow-y:scroll;box-shadow:5px 5px 8px #888888">

	</div>

	<div id="div2" style="width:80%;height:13%;margin:3% auto 0 auto;box-shadow:5px 5px 8px #888888">
		<div id="desertDiv" style="display:none;float:left;width:50%;text-align:center;height:100%">
			<div style="color:#EB9239;font-size:3.5vw;height:15%;padding-top:3%;margin-bottom:5%">Sugar Level</div>
			<div style="text-align:right;padding-right:30%">
				<span style="font-size:2.5vw;">Regular</span>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
				<input type="radio" name="a" style="width:3vw;height:3vw;margin-top:3%" value="1" checked/>
			</div>
			<div style="text-align:right;padding-right:30%">
				<span style="font-size:2.5vw;">Half Sugar</span>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
				<input type="radio" name="a" style="width:3vw;height:3vw;margin-top:3%" value="2"/>
			</div>
			<div style="text-align:right;padding-right:30%">
				<span style="font-size:2.5vw;">Sugar Free</span>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
				<input type="radio" name="a" style="width:3vw;height:3vw;margin-top:3%" value="3"/>
			</div>
		</div>
		<div id="drinkDiv" style="display:none;float:right;width:50%;text-align:center;height:100%">
			<div style="color:#EB9239;font-size:3.5vw;height:15%;padding-top:3%;margin-bottom:5%">Ice Level</div>
			<div style="text-align:right;padding-right:30%">
				<span style="font-size:2.5vw;">Regular</span>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
				<input type="radio" name="b" style="width:3vw;height:3vw;margin-top:3%" value="1" checked/>
			</div>
			<div style="text-align:right;padding-right:30%">
				<span style="font-size:2.5vw;">Less Ice</span>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
				<input type="radio" name="b" style="width:3vw;height:3vw;margin-top:3%" value="2"/>
			</div>
			<div style="text-align:right;padding-right:30%">
				<span style="font-size:2.5vw;">No Ice</span>
				&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
				<input type="radio" name="b" style="width:3vw;height:3vw;margin-top:3%" value="3"/>
			</div>
		</div>
	</div>

	<div id="foot" style="position:fixed;bottom:0;height:10%;width:100%;background-color:#000">
		<div data-toggle="modal" data-target="#cancelTransModal" class="foot3" style="text-align:center;float:left;width:20%;font-size:3vw;color:#fff;">
			<span  class="glyphicon glyphicon-remove footMenu" style="width:10vw;height:10vw;line-height:10vw;margin-top:12%;font-size:5vw;color:black; background:white;-webkit-border-radius: 100% 100% 100% 100%;"></span>
			<br/>
			<span class="footMenuWord" style="line-height: 60px; font-size: 30px;">Cancel</span> |
			<span class="footMenuWord" style="line-height: 60px; font-size: 30px;">取消</span>
		</div>
		<div  class="foot3" style="text-align:center;float:left;width:20%;font-size:3vw;color:#fff;">
			<span onClick="javascript:history.back(-1)"  class="glyphicon  glyphicon-arrow-left footMenu" style="width:10vw;height:10vw;line-height:10vw;margin-top:12%;font-size:5vw;color:black; background:white;-webkit-border-radius: 100% 100% 100% 100%;"></span>
			<br/>
			<span class="footMenuWord" style="line-height: 60px; font-size: 30px;">Back</span> |
			<span class="footMenuWord" style="line-height: 60px; font-size: 30px;">返回</span>
		</div>
		<div  class="foot3" style="text-align:center;float:left;width:20%;font-size:3vw;color:#fff;">
			<span onClick="javascript:window.location.href='menu.html'"  class="glyphicon glyphicon-home footMenu" style="width:10vw;height:10vw;line-height:10vw;margin-top:12%;font-size:5vw;color:black; background:white;-webkit-border-radius: 100% 100% 100% 100%;"></span>
			<br/>
			<span class="footMenuWord" style="line-height: 60px; font-size: 30px;">Menu</span> |
			<span class="footMenuWord" style="line-height: 60px; font-size: 30px;">菜單</span>
		</div>
		<div  class="foot3" style="text-align:center;float:left;width:20%;font-size:3vw;color:#fff;">
			<span id="addToCart" class="glyphicon glyphicon-check footMenu" style="width:10vw;height:10vw;line-height:10vw;margin-top:12%;font-size:5vw;color:black; background:white;-webkit-border-radius: 100% 100% 100% 100%;"></span>
			<br/>
			<span class="footMenuWord" style="line-height: 60px; font-size: 30px;">Add</span> |
			<span class="footMenuWord" style="line-height: 60px; font-size: 30px;">加入</span>
		</div>
		<div class="foot3 cart"
			style="
				text-align: center;
				float: left;
				width: 20%;
				font-size: 3vw;
				color: #fff;
				position: relative;
			">
			<span onclick="javascript:location.href='cart.html'" class="glyphicon glyphicon-shopping-cart footMenu" style="width:10vw;height:10vw;line-height:10vw;margin-top:12%;font-size:5vw;color:black; background:white;-webkit-border-radius: 100% 100% 100% 100%;"></span>
			<br/>
			<span class="footMenuWord" style="line-height: 60px; font-size: 30px;">Cart</span> |
			<span class="footMenuWord" style="line-height: 60px; font-size: 30px;">購物車</span>
		</div>
	</div>
	<div id="cancelTransModal" class="modal fade" role="dialog">
		<div class="modal-dialog modal-lg">
		<!-- Modal content-->
			<div class="modal-content">
				<div class="modal-body">
					<p>Are you sure you want to cancel this order ?</p>
				</div>
				<div class="modal-footer">
					<button id="cancelTrans" type="button" class="btn btn-default" data-dismiss="modal">Yes</button>
					<button type="button" class="btn btn-default" data-dismiss="modal">No</button>
				</div>
			</div>
		</div>
	</div>
	<div id="snackbar"></div>
	<!--
	<div id="foot" style="position:fixed;bottom:0;height:10%;width:100%;background-color:#000">
		<div id="cancelTrans" style="text-align:center;float:left;width:20%">
			<span  class="glyphicon glyphicon-remove" id="cancelTrans" style="width:11vw;height:11vw;line-height:11vw;margin-top:12%;font-size:8vw;color:black; background:white;-webkit-border-radius: 100% 100% 100% 100%;"></span>
		</div>
		<div style="text-align:center;float:left;width:20%" onClick="javascript:history.back(-1)">
			<span class="glyphicon glyphicon-arrow-left" style="width:11vw;height:11vw;line-height:11vw;margin-top:12%;font-size:8vw;color:black; background:white;-webkit-border-radius: 100% 100% 100% 100%;"></span>
		</div>
		<div style="text-align:center;float:left;width:20%" onClick="javascript:window.location.href='menu.html'">
			<span class="glyphicon glyphicon-home" style="width:11vw;height:11vw;line-height:11vw;margin-top:12%;font-size:8vw;color:black; background:white;-webkit-border-radius: 100% 100% 100% 100%;"></span>
		</div>
		<div id="addToCart" style="text-align:center;float:left;width:20%">
			<span class="glyphicon glyphicon-check" style="width:11vw;height:11vw;line-height:11vw;margin-top:12%;font-size:8vw;color:black; background:white;-webkit-border-radius: 100% 100% 100% 100%;"></span>
		</div>
		<div style="text-align:center;float:left;width:20%">
			<span onclick="javascript:location.href='cart.html'" class="glyphicon glyphicon-shopping-cart" style="width:11vw;height:11vw;line-height:11vw;margin-top:12%;font-size:8vw;color:black; background:white;-webkit-border-radius: 100% 100% 100% 100%;"></span>
		</div>
	</div>
	-->

	<script>
	autoCancelTrans()

	// 获得传值类型 ,传输值为 groupCode的值
	var getJsonObj=getQueryString()
	var image = getJsonObj.image
	var desc =  unescape(decodeURI(getJsonObj.description).replace(/＼u/g, "%u")); 
	var note1 = unescape(decodeURI(getJsonObj.note1).replace(/＼u/g, "%u")); 
	var note2 = unescape(decodeURI(getJsonObj.note2).replace(/＼u/g, "%u")); 
	var groupID= getJsonObj.groupID
	var articleCode=getJsonObj.articleCode

	$(function(){
		// 以下是div1
		$("#img").css({
			"background":"url("+unescape(image)+")",
			"background-size":"100% 100%",
			"background-repeat":"no-repeat",
			"width":"80%",
			"height":"80%",
			"margin":"10% auto 0 auto"

		})
		$("#desc").text(desc)
		$("#desc").css({
			"line-height":$("#desc").height()+"px"
		})

		$("#note1").text(note1=="null"?"":note1)
		$("#note2").text(note2=="null"?"":("*"+note2))

		// 以下是div2

		try
		{
			$resultStr=callHostPost("isDrink", {"data":""+groupID+""} ) ;
			$result = JSON.parse($resultStr);
			console.log("获得是否是drink");
			console.log("结果："+$resultStr);

			// 在div3中是否显示ice
			if($result.resultCode==2)
			{
				$("#drinkDiv").show();
				$("#desertDiv").show();
			}

			if($result.resultCode==1)
			{
				alert("system error")
			}
			else
			{
				$additionalType=$result.resultCode==2?99002:99001
				$articleResult = JSON.parse(callHostPost("getAdditionalArticle", {"data":""+$additionalType+""} ) );
					console.log($articleResult)
				var json=[]; // 获取所有是公共additional的和是对应drink或dessert的
				$.each($articleResult.result,function(){
					if(this.groupcode=="99000" || this.groupcode==$additionalType)
					{
						$.each(this.articles,function(){
							json.push(this);
						})
					}
				})

				// 构建 additional中的内容
				// 1元topping的标题
				$div1 = $("<div>$1.0 / each</div>")
				$div1.css({
					"text-align":"center",
					"color":"#EB9239",
					"font-size":"3.5vw",
					"height":"10%",
					"margin-top":"3%"
				})
				$("#div2").append($div1)

				// 1元价格的topping
				$.each(json,function(){
					if(this.prices[0].price==1)
					{
						createAdditionalLine(this)
					}
				})

				// 0.5元topping的标题
				$div3 = $("<div>$0.5 / each</div>")
				$div3.css({
					"text-align":"center",
					"color":"#EB9239",
					"font-size":"3.5vw",
					"height":"10%",
					"margin-top":"3%"
				})
				$("#div2").append($div3)

				// 0.5元价格的topping
				$.each(json,function(){
					if(this.prices[0].price==0.5)
					{
						createAdditionalLine(this)
					}
				})

			}
		}
		catch(e)
		{
			console.log("这里是网络错误。。");
			console.log(e.name+","+e.message);
			alert("system error")
		}

		// 一下是foot

		// add cart
		$("#addToCart").click(function(){
			addCart();
			let cart = $('.cart');
			let imgToDrag = $('#img');
			if(imgToDrag){
				let imgclone = imgToDrag.clone()
	                .offset({
	                top: imgToDrag.offset().top,
	                left: imgToDrag.offset().left
	            }).css({
	                'opacity': '1',
	                    'position': 'absolute',
	                    'height': '150px',
	                    'width': '150px',
	                    'z-index': '100'
	            }).appendTo($('body'))
	                .animate({
	                	'top': cart.offset().top - 35,
	                    'left': cart.offset().left + 100,
	                    'width': 75,
	                    'height': 75
	            }, 800, 'easeInOutExpo');
				imgclone.animate({
	                'width': 0,
                    'height': 0
	            }, function () {
	                $(this).detach();
					addToCartBadgeUpdate();
					var x = document.getElementById("snackbar");
				    // Add the "show" class to DIV
				    x.className = "show";
					x.innerText = 'Added successfully';
				    // After 3 seconds, remove the show class from DIV
				    setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
	            });
			}

		})
		addToCartBadgeUpdate();
		$("#cancelTrans").click(function(){
			try
			{
				var result =  JSON.parse(callHostGet("cancelTransaction"))
				if(result.result.result=="OK")
				{
					window.location.href="index.html"
				}
				else
				{
					console.log("Cancel Transaction failed,please try again")
				}
			}
			catch
			{
				console.log("Cancel Transaction failed,please try again")
			}
		})
	})
	// Cart badge
	let addToCartBadgeUpdate = () => {
		let orderList = JSON.parse(callHostPost("getTransactionArticle",{data:"1"}));
		if(orderList.itemList.length > 0){
			$('.cart-badge').remove();
			$('.cart').append($('<span class="cart-badge">' + orderList.itemList.length + '</span>'))
		}
	}

	function addCart()
	{
		var requestJson={};
		var subitems=[];
		requestJson.code=articleCode;
		//requestJson.pricelevel=1;
		$index = 0;
		$.each($("#div2").find("input"),function(){
			for($i=0;$i<=$(this).val()*1-1;$i++)
			{
				$index++
				var additional = {};
				additional.ordernum=$index;
				additional.articlecode=$(this).attr("articleCode");
				additional.commentcode=null;
				subitems.push(additional);
			}
		})
		requestJson.subitems = subitems;

		console.log({data: JSON.stringify(requestJson)});
		var articlesss = JSON.parse(callHostPost("addArticle",{data: JSON.stringify(requestJson)}))
			console.log(articlesss)

			var addIceJson = {}
			addIceJson.articleid=articlesss.result.itemID;
			if(!$("#desertDiv").is(":hidden"))
			{
				addIceJson.sugar=$("input[name='a']:checked").val();
			}
			if(!$("#drinkDiv").is(":hidden"))
			{
				addIceJson.ice=$("input[name='b']:checked").val();
			}
			callHostPost("addSugarAndIce",{data: JSON.stringify(addIceJson)})

	}

	// 按照价格创建additional 每一行
	function createAdditionalLine(singleAddition)
	{
		$div2 = $("<div></div>")
		$div2.css({
			"text-align":"right",
			"font-size":"3vw",
			"margin-bottom":"2%",
			"padding-left":"10%",
			"padding-right":"10%",
		})
		$span1=$("<span style='margin-right:5%'>"+singleAddition.defaultdescription+"</span>")
		$input=$("<input articlecode='"+singleAddition.articlecode+"' type='text' style='width:10%;margin-right:5%;height:3vw' value='0'/>")

		$span2=$("<span style='margin-right:2%' class='glyphicon glyphicon-plus-sign'></span>")
		$span2.on("click",function(){
			$(this).prev().val($(this).prev().val()*1+1)
		})

		$span3=$("<span class='glyphicon glyphicon-minus-sign'></span>")
		$span3.on("click",function(){
			$(this).prev().prev().val($(this).prev().prev().val()*1==0?0:$(this).prev().prev().val()-1)
		})

		$div2.append($span1)
		$div2.append($input)
		$div2.append($span2)
		$div2.append($span3)
		$("#div2").append($div2)
	}

	// 得到get传值
	function getQueryString() {
		 //首先获取地址
                var url = url || window.location.href;
                //获取传值
                var arr = url.split("?");
                //判断是否有传值
                if(arr.length == 1){
                    return null;
                }
                //获取get传值的个数
                var value_arr = arr[1].split("&");
                //循环生成返回的对象
                var obj = {};
                for(var i = 0; i < value_arr.length; i++){
                    var key_val = value_arr[i].split("=");
                    obj[key_val[0]]=key_val[1];
                }
                return obj;
    }

	// post ajax请求
	function callHostPost(command, parameters) {
		// Create the query string readimg the fields of the passed parameters object
		var qs = '';
		  if (parameters != null) {
			for(var key in parameters)
			  qs += encodeURIComponent(key) + '=' + encodeURIComponent(parameters[key]) + '&';
		  }
		  // Remove last ampersand
		  if (qs.length > 0)
			qs = '?' + qs.substring(0, qs.length-1);

		  var request = new XMLHttpRequest();
		  // `false` makes the request synchronous
		  request.open('POST', 'http://localhost:8080/kiosk/'+command, false);
		  request.send(qs);

		  if (request.status === 200)
			return request.responseText;
		  else
			return '!error ' + request.status;
		}

	// get ajax请求
	function callHostGet(command, parameters) {
	    // Create the query string readimg the fields of the passed parameters object
	    var qs = '';
	      if (parameters != null) {
	        for(var key in parameters)
	          qs += encodeURIComponent(key) + '=' + encodeURIComponent(parameters[key]) + '&';
	      }
	      // Remove last ampersand
	      if (qs.length > 0)
	        qs = '?' + qs.substring(0, qs.length-1);

	      var request = new XMLHttpRequest();
	      // `false` makes the request synchronous
	      request.open('GET', 'http://localhost:8080/kiosk/'+command, false);
	      request.send(qs);

	      if (request.status === 200)
	        return request.responseText;
	      else
	        return '!error ' + request.status;
	    }
	</script>
</body>
</html>
